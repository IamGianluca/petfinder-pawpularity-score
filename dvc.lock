schema: '2.0'
stages:
  download_data:
    cmd: kaggle competitions download -c petfinder-pawpularity-score -p data/
    outs:
    - path: data/petfinder-pawpularity-score.zip
      md5: 35dd50bacd33ebba746738508e20e276
      size: 1030728211
  unzip_data:
    cmd: unzip data/petfinder-pawpularity-score.zip -d data/
    deps:
    - path: data/petfinder-pawpularity-score.zip
      md5: 35dd50bacd33ebba746738508e20e276
      size: 1030728211
    outs:
    - path: data/sample_submission.csv
      md5: eed5ebc04c54d5e5130a85a4d81dfc6e
      size: 326
    - path: data/test
      md5: e945e75c5c4c977b08ad644851755e27.dir
      size: 83775
      nfiles: 8
    - path: data/test.csv
      md5: 4e4d1b962044457c29f636cc02716e46
      size: 545
    - path: data/train
      md5: 065c7f4be0d67e5175f532982b56cb52.dir
      size: 1039930050
      nfiles: 9912
    - path: data/train.csv
      md5: a7812f42b71d57e77dfc6e05f5cdd865
      size: 594740
  create_folds:
    cmd: python pipe/create_folds.py
    deps:
    - path: data/train_deduped.csv
      md5: a19b722d94bf2f664c9770c4c2e12575
      size: 640790
    - path: pipe/create_folds.py
      md5: 0e2e4da36693df31bd0dafb196f60e77
      size: 1125
    params:
      params.yaml:
        create_folds:
          seed: 42
          k:
          - 5
          - 10
    outs:
    - path: data/train_10folds.csv
      md5: 2e136ecbf70718f80898b57cbd7fe878
      size: 660556
    - path: data/train_5folds.csv
      md5: df60fb7c97941742af389960321d6f97
      size: 660556
  train_one:
    cmd: python pipe/train_one.py
    deps:
    - path: data/train_10folds.csv
      md5: 2e136ecbf70718f80898b57cbd7fe878
      size: 660556
    - path: data/train_384
      md5: 3e12f820928b7b6770891beda13b8af2.dir
      size: 236133550
      nfiles: 9912
    - path: data/train_5folds.csv
      md5: df60fb7c97941742af389960321d6f97
      size: 660556
    - path: pipe/train_one.py
      md5: cabbdf809431455dec8552222e449e1e
      size: 5921
    params:
      params.yaml:
        train_one:
          name: one
          seed: 5899
          n_folds: 5
          fold: -1
          metric: rmse
          metric_mode: min
          train_data: data/train_384
          arch: swin_large_patch4_window12_384
          pretrained: true
          epochs: 6
          bs: 16
          auto_batch_size: false
          accumulate_grad_batches: 1
          precision: 16
          use_normalize: true
          n_tfms: 2
          magn: 3
          sz: 384
          use_mix: 0
          mix_p: 0.0
          resize: -1
          dropout: 0.0
          wd: 0.0
          label_smoothing: 0.1
          loss: bce_with_logits
          opt: adamw
          sched: cosine
          lr: 6e-06
          warmup_epochs: 1
          auto_lr: false
          mom: 0.9
    outs:
    - path: ckpts/model_one_fold0.ckpt
      md5: 93443155d320d4f104d7a91c95f009c0
      size: 795374561
    - path: ckpts/model_one_fold1.ckpt
      md5: a5c882f6beeadd5069c98da2ffbc090b
      size: 795374561
    - path: ckpts/model_one_fold2.ckpt
      md5: 7679c5da9a3686985cd93f806741f72d
      size: 795374561
    - path: ckpts/model_one_fold3.ckpt
      md5: 3c2d8a78aba93f8c4531cb7f46085804
      size: 795374561
    - path: ckpts/model_one_fold4.ckpt
      md5: 6a9ef69fb43feaa2a7023825e7f08b14
      size: 795374561
    - path: metrics/model_one.json
      md5: bbd540db72a2ce3c8e84fc25870adc13
      size: 60
    - path: preds/model_one_fold0.npy
      md5: 9f2b2948fd75629e37aba1c5a979367b
      size: 8028
    - path: preds/model_one_fold1.npy
      md5: 2c2e432e5c8be3893302aee0c1d70308
      size: 8028
    - path: preds/model_one_fold2.npy
      md5: 8ed0620a4c7993595c641070f4a91c26
      size: 8028
    - path: preds/model_one_fold3.npy
      md5: 5508d5d661dfdbb49e01478062c1e382
      size: 8028
    - path: preds/model_one_fold4.npy
      md5: aa414bc74ecec18327044c228659719f
      size: 8028
  resize_images:
    cmd: python pipe/resize_images.py
    deps:
    - path: data/test
      md5: e945e75c5c4c977b08ad644851755e27.dir
      size: 83775
      nfiles: 8
    - path: data/train
      md5: 065c7f4be0d67e5175f532982b56cb52.dir
      size: 1039930050
      nfiles: 9912
    - path: pipe/resize_images.py
      md5: 22b4e2500eb69a98b5f32cd73384fa8e
      size: 854
    params:
      params.yaml:
        resize:
          sz:
          - 224
          - 384
    outs:
    - path: data/test_224/
      md5: 8b2b276f61b204b6d52b9d73191cfd83.dir
      size: 170719
      nfiles: 8
    - path: data/test_384/
      md5: ed7b545ec573e12362fca208e03d60a0.dir
      size: 367783
      nfiles: 8
    - path: data/train_224/
      md5: 3452a5af5bd28029d534ec33b0bd09f4.dir
      size: 97308155
      nfiles: 9912
    - path: data/train_384/
      md5: 3e12f820928b7b6770891beda13b8af2.dir
      size: 236133550
      nfiles: 9912
  train_two:
    cmd: python pipe/train_two.py
    deps:
    - path: data/train_10folds.csv
      md5: 2e136ecbf70718f80898b57cbd7fe878
      size: 660556
    - path: data/train_224
      md5: 3452a5af5bd28029d534ec33b0bd09f4.dir
      size: 97308155
      nfiles: 9912
    - path: data/train_5folds.csv
      md5: df60fb7c97941742af389960321d6f97
      size: 660556
    - path: pipe/train_two.py
      md5: fa4778a3d32b92d9f5879f85d9d701d2
      size: 5921
    params:
      params.yaml:
        train_two:
          name: two
          seed: 7591
          n_folds: 5
          fold: -1
          metric: rmse
          metric_mode: min
          train_data: data/train_224
          arch: swin_large_patch4_window7_224
          pretrained: true
          epochs: 6
          bs: 64
          auto_batch_size: false
          accumulate_grad_batches: 1
          precision: bf16
          use_normalize: true
          n_tfms: 1
          magn: 5
          sz: 224
          use_mix: 0
          mix_p: 0.0
          resize: -1
          dropout: 0.0
          wd: 0.0
          label_smoothing: 0.1
          loss: bce_with_logits
          opt: adamw
          sched: cosine
          warmup_epochs: 1
          lr: 2.4e-05
          auto_lr: false
          mom: 0.9
    outs:
    - path: ckpts/model_two_fold0.ckpt
      md5: c2f70b9a3d58a7d2446d796487b93678
      size: 782534305
    - path: ckpts/model_two_fold1.ckpt
      md5: fabe76f129f831b201535f57253bcf8c
      size: 782534305
    - path: ckpts/model_two_fold2.ckpt
      md5: 5d88c6b9d59111bfd7e9dd4fcee1e46e
      size: 782534305
    - path: ckpts/model_two_fold3.ckpt
      md5: f91570cb693e5e934ff3d2b7e39d73c1
      size: 782534305
    - path: ckpts/model_two_fold4.ckpt
      md5: f91ae908d06464105f6bc0c1384a8a04
      size: 782534305
    - path: metrics/model_two.json
      md5: 94c436d7599acc83d071200d4bdbfdd6
      size: 61
    - path: preds/model_two_fold0.npy
      md5: 7c72f71c460b448621a54e5392801fb5
      size: 8028
    - path: preds/model_two_fold1.npy
      md5: 6c172257ce0b2f83e1becfafd28b34b8
      size: 8028
    - path: preds/model_two_fold2.npy
      md5: cdfea5210b972d1f4de7907e8ff36f03
      size: 8028
    - path: preds/model_two_fold3.npy
      md5: 3fe7c8e9d60460d76caf13fab862666a
      size: 8028
    - path: preds/model_two_fold4.npy
      md5: 2557e577bfd15898e2e6af7148b7ae96
      size: 8028
  remove_duplicates:
    cmd: python pipe/remove_duplicate_images.py
    deps:
    - path: data/train
      md5: 065c7f4be0d67e5175f532982b56cb52.dir
      size: 1039930050
      nfiles: 9912
    - path: pipe/remove_duplicate_images.py
      md5: 6e6f526909266d3a1af7af13c985a3cd
      size: 3931
    outs:
    - path: data/train_deduped.csv
      md5: a19b722d94bf2f664c9770c4c2e12575
      size: 640790
