schema: '2.0'
stages:
  download_data:
    cmd: kaggle competitions download -c petfinder-pawpularity-score -p data/
    outs:
    - path: data/petfinder-pawpularity-score.zip
      md5: 35dd50bacd33ebba746738508e20e276
      size: 1030728211
  unzip_data:
    cmd: unzip data/petfinder-pawpularity-score.zip -d data/
    deps:
    - path: data/petfinder-pawpularity-score.zip
      md5: 35dd50bacd33ebba746738508e20e276
      size: 1030728211
    outs:
    - path: data/sample_submission.csv
      md5: eed5ebc04c54d5e5130a85a4d81dfc6e
      size: 326
    - path: data/test
      md5: e945e75c5c4c977b08ad644851755e27.dir
      size: 83775
      nfiles: 8
    - path: data/test.csv
      md5: 4e4d1b962044457c29f636cc02716e46
      size: 545
    - path: data/train
      md5: 065c7f4be0d67e5175f532982b56cb52.dir
      size: 1039930050
      nfiles: 9912
    - path: data/train.csv
      md5: a7812f42b71d57e77dfc6e05f5cdd865
      size: 594740
  create_folds:
    cmd: python pipe/create_folds.py
    deps:
    - path: data/train_deduped.csv
      md5: f81d9c4c779ac671c8cbe4db1434f950
      size: 661548
    - path: pipe/create_folds.py
      md5: 03c7c7dbb5a1d6e3a0b1af47941c0e87
      size: 773
    params:
      params.yaml:
        create_folds:
          seed: 6822
          k: 5
    outs:
    - path: data/train_folds.csv
      md5: b9da27ec2c199975db0c599e64685d13
      size: 661559
  train_one:
    cmd: python pipe/train_one.py
    deps:
    - path: data/train_384
      md5: 3e12f820928b7b6770891beda13b8af2.dir
      size: 236133550
      nfiles: 9912
    - path: data/train_folds.csv
      md5: b9da27ec2c199975db0c599e64685d13
      size: 661559
    - path: pipe/train_one.py
      md5: e19ac6fd10d8213834116150e4ebbaac
      size: 4760
    params:
      params.yaml:
        train_one:
          seed: 46
          fold: -1
          metric: rmse
          metric_mode: min
          train_data: data/train_384
          arch: swin_large_patch4_window12_384
          pretrained: true
          epochs: 10
          bs: 8
          auto_batch_size: false
          accumulate_grad_batches: 1
          precision: 32
          use_normalize: true
          n_tfms: 2
          magn: 3
          sz: 384
          use_mix: 0
          mix_p: 0.0
          resize: -1
          dropout: 0.0
          wd: 0.0
          label_smoothing: 0.0
          loss: bce_with_logits
          opt: adam
          sched: onecycle
          lr: 2.5e-05
          warmup: 0.25
          auto_lr: false
          mom: 0.9
    outs:
    - path: ckpts/model_one_fold0.ckpt
      md5: e63b5958c21a5fd61079ddd4ca29e7a7
      size: 795372513
    - path: ckpts/model_one_fold1.ckpt
      md5: 0d7c80244874521043498bb1e829011f
      size: 795372513
    - path: ckpts/model_one_fold2.ckpt
      md5: 8d6363f97024abcfe389a001bfc5991d
      size: 795372513
    - path: ckpts/model_one_fold3.ckpt
      md5: b9bfefedd1f216199a22415f91676774
      size: 795372513
    - path: ckpts/model_one_fold4.ckpt
      md5: 58da18b9eb007955239213454a88b959
      size: 795372513
    - path: metrics/model_one.json
      md5: cac3e3f0428ff883dd501b1f3f8b61aa
      size: 45
    - path: preds/model_one_fold0.npy
      md5: 412dc53b456bf2d08466045528c598dc
      size: 8040
    - path: preds/model_one_fold1.npy
      md5: 9caed47baa8bf9683d953343105a15f1
      size: 8040
    - path: preds/model_one_fold2.npy
      md5: 839bdb5120215708b70f443a0f59b696
      size: 8040
    - path: preds/model_one_fold3.npy
      md5: c52ffcbfc63f68dfd6c7e777cf0b19e2
      size: 8040
    - path: preds/model_one_fold4.npy
      md5: 2d222edd0b24270eef3ddef8d5c17a96
      size: 8040
  resize_images:
    cmd: python pipe/resize_images.py
    deps:
    - path: data/test
      md5: e945e75c5c4c977b08ad644851755e27.dir
      size: 83775
      nfiles: 8
    - path: data/train
      md5: 065c7f4be0d67e5175f532982b56cb52.dir
      size: 1039930050
      nfiles: 9912
    - path: pipe/resize_images.py
      md5: 22b4e2500eb69a98b5f32cd73384fa8e
      size: 854
    params:
      params.yaml:
        resize:
          sz:
          - 224
          - 384
    outs:
    - path: data/test_224/
      md5: 8b2b276f61b204b6d52b9d73191cfd83.dir
      size: 170719
      nfiles: 8
    - path: data/test_384/
      md5: ed7b545ec573e12362fca208e03d60a0.dir
      size: 367783
      nfiles: 8
    - path: data/train_224/
      md5: 3452a5af5bd28029d534ec33b0bd09f4.dir
      size: 97308155
      nfiles: 9912
    - path: data/train_384/
      md5: 3e12f820928b7b6770891beda13b8af2.dir
      size: 236133550
      nfiles: 9912
  train_two:
    cmd: python pipe/train_two.py
    deps:
    - path: data/train_224
      md5: 3452a5af5bd28029d534ec33b0bd09f4.dir
      size: 97308155
      nfiles: 9912
    - path: data/train_folds.csv
      md5: b9da27ec2c199975db0c599e64685d13
      size: 661559
    - path: pipe/train_two.py
      md5: 93074d375462de01b1bae0c0968f1cab
      size: 4760
    params:
      params.yaml:
        train_two:
          seed: 46
          fold: -1
          metric: rmse
          metric_mode: min
          train_data: data/train_224
          arch: swin_large_patch4_window7_224
          pretrained: true
          epochs: 6
          bs: 40
          auto_batch_size: false
          accumulate_grad_batches: 1
          precision: 32
          use_normalize: true
          n_tfms: 2
          magn: 3
          sz: 224
          use_mix: 0
          mix_p: 0.0
          resize: -1
          dropout: 0.0
          wd: 0.0
          label_smoothing: 0.1
          loss: bce_with_logits
          opt: adam
          sched: onecycle
          lr: 0.000125
          warmup: 0.25
          auto_lr: false
          mom: 0.9
    outs:
    - path: ckpts/model_two_fold0.ckpt
      md5: fce1c5dca5c6c849e4070c9ac88b17ce
      size: 782532321
    - path: ckpts/model_two_fold1.ckpt
      md5: e0490496825686e78d458d8393e41065
      size: 782532321
    - path: ckpts/model_two_fold2.ckpt
      md5: 5578b080206482daeb1e25ab168fcd47
      size: 782532321
    - path: ckpts/model_two_fold3.ckpt
      md5: 6185e9ef83eac2e4a1fb34cbee99a692
      size: 782532321
    - path: ckpts/model_two_fold4.ckpt
      md5: 16114486b8ef1bf9d4bbb1bec24d2356
      size: 782532321
    - path: metrics/model_two.json
      md5: fb58930dcfe136e30562d1c0e3f2dc94
      size: 45
    - path: preds/model_two_fold0.npy
      md5: 290c5b01bbc93099d34d26f3b596dcfe
      size: 8040
    - path: preds/model_two_fold1.npy
      md5: becaaba777c532bd6f990e9291a60de1
      size: 8040
    - path: preds/model_two_fold2.npy
      md5: f34dce6901e3bc7e2016724f17998421
      size: 8040
    - path: preds/model_two_fold3.npy
      md5: 5f4b31a7e4170991b58c3659b352c7f8
      size: 8040
    - path: preds/model_two_fold4.npy
      md5: 864c82e9217c614574f0a5c0e2cee9bc
      size: 8040
  remove_duplicates:
    cmd: python pipe/remove_duplicate_images.py
    deps:
    - path: data/train
      md5: 065c7f4be0d67e5175f532982b56cb52.dir
      size: 1039930050
      nfiles: 9912
    - path: pipe/remove_duplicate_images.py
      md5: 133332057839470a4ecaa327417561c6
      size: 1727
    outs:
    - path: data/train_deduped.csv
      md5: f81d9c4c779ac671c8cbe4db1434f950
      size: 661548
